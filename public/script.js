// Utility to show party popper
function showPartyPopper() {
    const confettiContainer = document.getElementById('confetti-container');
    if (!confettiContainer) return;

    confettiContainer.style.display = 'block';

    // Simple confetti using vanilla JS
    for (let i = 0; i < 50; i++) {
        createConfettiPiece(confettiContainer);
    }

    setTimeout(() => {
        confettiContainer.style.display = 'none';
        confettiContainer.innerHTML = '';
    }, 3000);
}

function createConfettiPiece(container) {
    const piece = document.createElement('div');
    piece.classList.add('confetti-piece');
    piece.style.left = Math.random() * 100 + '%';
    piece.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
    piece.style.animation = `fall ${Math.random() * 2 + 1}s linear forwards`;
    container.appendChild(piece);
}

// Add keyframes for falling confetti dynamically
const styleDate = document.createElement('style');
styleDate.innerHTML = `
@keyframes fall {
    0% { top: -10%; opacity: 1; transform: rotate(0deg); }
    100% { top: 110%; opacity: 0; transform: rotate(720deg); }
}`;
document.head.appendChild(styleDate);

// API Handlers
async function handleRegister(event) {
    event.preventDefault();
    const form = event.target;
    // uid, uname, password, email, phone
    // Assuming UID is auto-generated by backend/DB
    const data = {
        uname: form.uname.value,
        password: form.password.value,
        email: form.email.value,
        phone: form.phone.value
    };

    try {
        const res = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok) {
            alert('Registration Successful! Redirecting to Login...');
            window.location.href = '/login.html';
        } else {
            document.getElementById('message').textContent = result.message || 'Error registering';
        }
    } catch (err) {
        document.getElementById('message').textContent = 'Network Error';
    }
}

async function handleLogin(event) {
    event.preventDefault();
    const form = event.target;
    const data = {
        username: form.username.value,
        password: form.password.value
    };

    try {
        const res = await fetch('/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await res.json();

        if (res.ok) {
            window.location.href = result.redirect || '/dashboard.html';
        } else {
            document.getElementById('message').textContent = result.message || 'Error logging in';
        }
    } catch (err) {
        document.getElementById('message').textContent = 'Network Error';
    }
}

async function checkBalance() {
    try {
        const res = await fetch('/balance');
        const result = await res.json();

        if (res.ok) {
            const display = document.getElementById('balance-display');
            display.textContent = `Your balance is : ${result.balance}`;
            display.classList.add('visible');
            showPartyPopper();
        } else {
            if (res.status === 401 || res.status === 403) {
                alert('Session expired. Please login again.');
                window.location.href = '/login.html';
            } else {
                alert(result.message || 'Error checking balance');
            }
        }
    } catch (err) {
        console.error(err);
        alert('Network Error');
    }
}
